<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Editor de Equações</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"> <!-- CSS do KATEX-->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script> <!-- Importando o KATEX-->

    <style>
        * {
            margin: 0%;
            padding: 0%;
        }

        body {
            background-color: cornflowerblue;
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .editor {
            border: 1px solid #999999;
            background-color: white;
            padding: 10px;
            min-height: 100px;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .button-group {
            margin-bottom: 20px;
        }

        .button-group h4 {
            margin: 10px 0;
            font-size: 16px;
            color: #333;
            font-weight: bold;
            border-left: 4px solid #0077cc;
            padding-left: 8px;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            background-color: #f0f0f0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 15px;
            gap: 12px;
        }

        .toolbar-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 4px 10px;
            border-right: 1px solid #ccc;
        }

        .toolbar-section:last-child {
            border-right: none;
        }

        .section-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
        }

        .toolbar-section button {
            background-color: #fff;
            border: 1px solid #ccc;
            color: #333;
            padding: 4px 8px;
            font-size: 14px;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            min-width: 40px;
            transition: all 0.2s ease;
        }

        .toolbar-section button:hover {
            background-color: #e6e6e6;
        }

        .toolbar-section button:active {
            background-color: #d0d0d0;
            transform: scale(0.97);
        }

        .output {
            border-top: 1px solid #ddd;
            margin-top: 20px;
            padding-top: 10px;
        }
    </style>

</head>

<body>
    <center>
        <h2>Editor de Equações - KaTeX</h2>
    </center>

    <div class="toolbar">
        <div class="toolbar-section">
            <div class="section-title">Operações</div>
            <button onclick="insertKatex('+', '', '+')">+</button>
            <button onclick="insertKatex('-', '', '-')">−</button>
            <button onclick="insertKatex('=', '', '=')">=</button>
            <button onclick="insertKatex('\\cdot', '', '\\cdot')">·</button>
            <button onclick="insertKatex('\\times', '', '\\times')">×</button>
            <button onclick="insertKatex('\\div', '', '\\div')">÷</button>
            <button onclick="insertKatex('\\dfrac{}{ }', '\\dfrac{}{ }', '\\dfrac{a}{b}')">Fração</button>
        </div>

        <div class="toolbar-section">
            <div class="section-title">Funções</div>
            <button onclick="insertKatex('\\sqrt{}', '\\sqrt{}', '\\sqrt{a}')">Raiz</button>
            <button onclick="insertKatex('^{}', '^{}', 'a^b')">Expoente</button>
            <button onclick="insertKatex('\\log_{}{}', '\\log_{}{}', '\\log_a b')">log</button>
            <button onclick="insertKatex('\\sin', '', '\\sin')">sin</button>
            <button onclick="insertKatex('\\cos', '', '\\cos')">cos</button>
            <button onclick="insertKatex('\\tan', '', '\\tan')">tan</button>
        </div>

        <div class="toolbar-section">
            <div class="section-title">Conjuntos</div>
            <button onclick="insertKatex('\\mathbb{N}', '', '\\mathbb{N}')">ℕ</button>
            <button onclick="insertKatex('\\mathbb{Z}', '', '\\mathbb{Z}')">ℤ</button>
            <button onclick="insertKatex('\\mathbb{Q}', '', '\\mathbb{Q}')">ℚ</button>
            <button onclick="insertKatex('\\mathbb{R}', '', '\\mathbb{R}')">ℝ</button>
            <button onclick="insertKatex('\\mathbb{C}', '', '\\mathbb{C}')">ℂ</button>
        </div>

        <div class="toolbar-section">
            <div class="section-title">Símbolos</div>
            <button onclick="insertKatex('\\pi', '', '\\pi')">π</button>
            <button onclick="insertKatex('\\in', '', '\\in')">∈</button>
            <button onclick="insertKatex('\\notin', '', '\\notin')">∉</button>
            <button onclick="insertKatex('\\subset', '', '\\subset')">⊂</button>
            <button onclick="insertKatex('\\subseteq', '', '\\subseteq')">⊆</button>
            <button onclick="insertKatex('\\cup', '', '\\cup')">∪</button>
            <button onclick="insertKatex('\\cap', '', '\\cap')">∩</button>
            <button onclick="insertKatex('\\', '', '\\')">Quebra de linha</button>
        </div>

        <div class="toolbar-section">
            <div class="section-title">Matrizes</div>
            <button onclick="insertKatex('\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}', '', '')">2×2</button>
            <button
                onclick="insertKatex('\\begin{pmatrix} a & b & c \\\\ d & e & f \\end{pmatrix}', '', '')">2×3</button>
        </div>

        <div class="toolbar-section">
            <div class="section-title">Sistemas</div>
            <button
                onclick="insertKatex('\\begin{cases} x + y = 2 \\\\ 2x - y = 3 \\end{cases}', '', '')">Sistema</button>
        </div>
    </div>

    <div contenteditable="true" id="equationInput" class="editor" placeholder="Escreva, neste campo, o enunciado...">
    </div>

    <button onclick="renderEquation()">Renderizar equação</button>

    <div class="output">
        <center>
            <h3>Equação Renderizada:</h3>
        </center>
        <div id="renderedEquation"></div>
    </div>

    <script>
        function insertKatex(codeToInsert, cursorPlaceholder = '', displayKatex = '') {
            const editor = document.getElementById("equationInput");
            const selection = window.getSelection();

            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);

            // Salva a posição do cursor
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(editor);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            const caretPosition = preCaretRange.toString().length;

            // Insere o texto KaTeX no input
            editor.focus();
            document.execCommand('insertText', false, codeToInsert);

            // Restaura o cursor para a posição correta, ou um placeholder se houver
            const newCaretPosition = caretPosition + codeToInsert.indexOf(cursorPlaceholder);

            if (cursorPlaceholder && codeToInsert.includes(cursorPlaceholder)) {
                // Encontra a posição do placeholder e move o cursor para lá
                let textNode = editor.firstChild;
                let charCount = 0;
                while (textNode) {
                    if (textNode.nodeType === Node.TEXT_NODE) {
                        if (charCount + textNode.length >= newCaretPosition) {
                            range.setStart(textNode, newCaretPosition - charCount);
                            range.setEnd(textNode, newCaretPosition - charCount);
                            selection.removeAllRanges();
                            selection.addRange(range);
                            break;
                        }
                        charCount += textNode.length;
                    }
                    textNode = textNode.nextSibling;
                }
            } else {
                // Se não houver placeholder, o cursor fica no final do texto inserido
                range.setStart(editor.firstChild, editor.innerText.length);
                range.setEnd(editor.firstChild, editor.innerText.length);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function renderEquation() {
            let input = document.getElementById("equationInput").innerText;
            const output = document.getElementById("renderedEquation");


            input = input.replace(/ /g, '\\;'); // Substitui os espaços por "\;" - é o que permite termos o enunciado associado à equação

            try {
                katex.render(input, output, {
                    throwOnError: false,
                    displayMode: true
                });
            } catch (err) {
                output.innerHTML = "<span style='color: red;'>Erro ao renderizar equação: " + err.message + "</span>";
                console.error(err);
            }
        }
    </script>

</body>

</html>